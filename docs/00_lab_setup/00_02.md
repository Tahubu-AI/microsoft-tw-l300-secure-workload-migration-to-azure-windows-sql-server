---
title: '2. Create on-premises resources'
layout: default
nav_order: 2
parent: 'Exercise 00: Lab Setup'
---

# Task 03 - Create on-premises resources

## Introduction

Tailspin Toys wants to migrate its SQL Server database and Web Application to Azure. In this task, you will create a simulated on-premises environment in Azure by deploying several resources using the provided ARM Template.

## Description

In this task, you will leverage a custom Azure Resource Manager (ARM) template to deploy the existing Azure resources and a simulated on-premises environment for Tailspin Toys.

The key tasks are as follows:

1. Retrieve your user information from Entra ID.
2. Deploy the [ARM Template](https://github.com/tahubu-ai/microsoft-tw-l300-secure-workload-migration-to-azure-windows-sql-server/tree/main/Hands-on%20lab/resources/deployment) to Azure.
3. Confirm that all resources have been deployed.

## Success Criteria

- You have retrieved the required information from Entra ID to create the custom deployment.
- You have successfully deployed the necessary Azure resources.

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1. Open a browser and navigate to the [Lab Deployment Scripts readme file](https://github.com/tahubu-ai/microsoft-tw-l300-secure-workload-migration-to-azure-windows-sql-server/tree/main/Hands-on%20lab/resources/deployment/readme.md) in the GitHub repository.

    {: .highlight }
    > If you're deploying to Azure Gov, open a browser with your corporate account profile loaded in it.

2. Select **Deploy to Azure** button on the **Lab Deployment Scripts** page to launch a custom deployment blade in the Azure portal.

    ![GitHub page with Deploy to Azure button highlighted](../../Hands-on%20lab/images/deploy-to-azure.png)

    {: .highlight }
    > If you're deploying to Azure Gov, select the **Deploy to Azure Gov** button.

3. If prompted, sign in with an account that is an owner of the Azure Subscription.

4. From the **Custom deployment** page in the Azure portal, select the **Cloud Shell** icon from the top bar of the Azure portal to open a cloud shell panel at the bottom of the browser window.

    ![The Azure Cloud Shell icon is highlighted on the top bar in the Azure portal.](../../Hands-on%20lab/images/azure-cloud-shell-icon.png)

5. At the **Cloud Shell** prompt, run the following Azure CLI command to retrieve the Entra ID information for your login.

    ```bash
    az ad signed-in-user show --query "{id:id, upn:userPrincipalName}" -o json
    ```

    The JSON output of the Azure CLI command includes your account's **id** and **upn** values. Leave the cloud shell panel open, as you will use these values in the next step to fill in the ARM template parameters.

    ![Command-line output with signed in user's Id and UPN from Entra ID.](../../Hands-on%20lab/images/az-signed-in-user-output.png)

    {: .important }
    > The ARM Template will use this user Id and User Principal Name as the Administrator account for the Azure SQL Managed Instance resource. This user must be an Entra ID user and cannot be a personal Microsoft Account.
    >
    > If necessary, look up an alternative user to use for this, then run the following command instead, replacing the `<azure-login>` placeholder with the user's email login. (e.g., `user@domain.onmicrosoft.com`)
    >
    > ```bash
    > az ad user show --id <azure-login>
    > ```

6. On the **Custom deployment** page, enter values for the required ARM template parameters.

   - **Subscription**: Ensure the correct Azure Subscription is selected.
   - **Resource group**: Select create new and enter a name, such as **rg-tw-tailspin-lab**.
   - **Region**: Choose an Azure region where you have available quota to deploy the needed resources.
   - **Azure Ad User Id**: Copy and paste the `id` value from the Cloud Shell output for your Entra ID account information.
   - **Azure Ad User Login**: Paste the `upn` value from the Cloud Shell output for your Entra ID account information.
   - **Onprem VM Size**: Select **Change size** and choose a VM size for which you have available quota.

     {: .highlight }
     You can run the following Azure CLI to get a list of SKUs usage in a specific Azure Region `az vm list-usage -l <location> -o table`.

   - **Sqlmi Sku**: Select `GP_Gen5` to deploy a *General Purpose - Generation 5* SQL Managed Instance.
   - **Sqlmi V Cores**: Choose `8` to deploy a *8 VCores* SQL Managed Instance.
   - Select **Review + create**.

     ![Azure Portal Create a new deployment standard window with entries to add all options needed to deploy the ARM template.](../../Hands-on%20lab/images/custom-deployment.png "Fill in the required ARM template parameters")

7. On the **Review + create** tab, review the terms and conditions and select **Create**.

    {: .highlight }
    The deployment is now underway. The custom deployment should take 10-15 minutes to complete. It is important that you monitor the deployment progress in the Azure portal to ensure there are no problems. You can monitor progress by selecting the notification bell in the upper right corner and selecting **Deployment in progress...**

    {: .note }
    > While automation can make things simpler and repeatable, sometimes it can fail. If at any time during the ARM template deployment there is a failure, review the failure, delete the Resource Group, and try the ARM template again, adjusting for errors.

8. Once the ARM template is deployed, the status will change to complete. Select **Go to resource group** to view the deployed resources and verify they deployed successfully.

    ![Azure Portal notification window showing deployment complete with Go to resource group link highlighted.](../../Hands-on%20lab/images/deployment-complete.png)

</details>
