---
title: '1. Enable Azure Arc'
layout: default
nav_order: 1
parent: 'Exercise 01: SQL Migration to Azure via Arc MI-Link'
---

# Task 01 - Enable Azure Arc

## Introduction

Tailspin Toys wants to migrate their on-premises SQL Server database to Azure SQL Managed Instance. In this first task, you will Arc-enable the on-premises SQL Server VM.

TODO: This whole lab needs to be updated to use Azure Arc, as Azure Data Studio and Azure Data Migration Assistant have been retired.

## Description

In this task, you will Azure Arc-enable the on-premises SQL Server VM. Azure Arc will allow Tailspin to leverage MI-Link for hybrid replication and failover to migrate their on-premises SQL Server database to Azure SQL Managed Instance.

The key tasks are as follows:

1. Connect via Azure Bastion to the `tailspin<uniqueid>-onprem-hyperv-vm` Virtual machine. This machine represents the on-premises SQL Server VM.
2. Set up Azure Arc on the on-premises SQL Server VM.

## Success Criteria

- You have connected to the VM via Azure Bastion
- Azure Arc has been enabled on the on-premises SQL Server VM

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1. In the Azure Portal, navigate to the Resource Group for the lab, then navigate to the `tailspin<uniqueid>-onprem-hyperv-vm` virtual machine. This VM is the Hyper-V host containing the on-premises SQL Server VM.

    ![The Virtual machine pane for the Simulated on-premises SQL Server VM is shown in the Azure Portal.](../../Hands-on%20lab/images/azure-portal-onprem-hyperv-vm.png)

    {: .note }
    > TODO: Add note about using Hyper-V guest VM for lab environment because Azure Arc Connected Machine agent cannot be installed on Azure VMs.

2. Select **Bastion** under **Connect** in the left navigation menu, and on the Bastion blade, enter the following username and password, ensure **Open in a new browser window** is checked, then select **Connect**.

    - **Username**: `demouser`
    - **Password**: `demo!pass123`

    ![The Bastion pane of the tailspin-onprem-sql-vm Virtual machine is shown with the Username and Password fields entered and highlighted.](../../Hands-on%20lab/images/sql-vm-connect-bastion.png)

3. If prompted to allow the browser to "see text and images copied to the clipboard," select **Allow**.

4. On the Hyper-V host VM, within the Bastion session, open **Hyper-V Manager** entering "hyper-v" into the search bar and selecting **Hyper-V Manager** in the result pane.

    ![The Hyper-V Manager application is shown.](../../Hands-on%20lab/images/hyper-v-manager-application.png "Hyper-V Manager")

5. In **Hyper-V Manager**, select **WINSERVER** from the list of resources, right-click the `OnPremSqlVM` in the Virtual Machines list, and select **Connect...**.

    ![The Hyper-V Manager is shown with the on-premises SQL VM highlighted and right-click menu shown with the Connect option highlighted.](../../Hands-on%20lab/images/hyper-v-manager-onprem-sql-vm-connect.png)

6. In the **Virtual Machine Connection** window, log in to the VM using the following credentials:

    - **Username** = `Administrator`
    - **Password** = `JS123!!`

    TODO: Verify the above creds

7. Once logged in to the on-premises SQL VM, open **Windows PowerShell** as Administrator by entering "powershell" into the search bar, right-clicking **Windows PowerShell**, and selecting **Run as administrator**.

    ![The Windows PowerShell (Admin) option is highlighted from the right-click Start menu.](../../Hands-on%20lab/images/windows-powershell-admin.png)

8. TODO: Determine if the follow scripts are needed for enabling Azure Arc on the SQL VM (via PowerShell). Otherwise, add the proper steps to enable Azure Arc on the VM below.

9. In the **PowerShell Script** pane, enter the following command to install the Azure Connected Machine agent:

    ```powershell
    Install-Module -Name Az.ConnectedMachine
    ```

10. Type "Y" when prompted to install the NuGet provider and trust the repository.

11. Type "A" to install the modules from 'PSGallery'.

12. Connect to Azure

    ```powershell
    Connect-AzAccount
    ```

13. Log in with your Azure credentials when prompted and allow the device to be registered with your account...

    {: .important }
    > If you have more than one subscription, select the tenant and subscription at the prompt.

14. TODO: Determine if this is necessary, or if `Connect-AzConnectedMachine` will handle it. Download and install the Azure Connected Machine agent (Connect-AzConnectedMachine should do this but doesn't seem to work)

    ```powershell
    Invoke-WebRequest -Uri https://aka.ms/AzureConnectedMachineAgent -OutFile AzureConnectedMachineAgent.msi
    ```

    ```powershell
    msiexec /i AzureConnectedMachineAgent.msi /qn
    ```

15. Set variables for Resource Group name, VM name, and location. TODO: Add details to get the right values for these variables.

    ```powershell
    $vmName = "tailspinb4k37qc-onprem-sql-vm"
    $resourceGroupName = "rg-tw-tailspin-lab"
    $location = "eastus"
    ```

16. Connect the on-premises SQL VM to Azure Arc:

    ```powershell
    Connect-AzConnectedMachine -ResourceGroupName $resourceGroupName -Name $vmName -Location $location
    ```

17. TODO: Determine if there are additional steps to connect SQL Server to Azure Arc.

</details>
